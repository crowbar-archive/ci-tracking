various cleanups and test tweaks 
