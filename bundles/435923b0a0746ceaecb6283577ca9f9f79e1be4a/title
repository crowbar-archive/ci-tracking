Flesh out wanted_attrs handling, and add some infrastructure for using it. 
