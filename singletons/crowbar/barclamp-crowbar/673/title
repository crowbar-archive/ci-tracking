avoid undefined method `foo' for nil:NilClass when state is nil
