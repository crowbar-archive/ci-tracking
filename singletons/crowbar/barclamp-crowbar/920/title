Fix potential race condition in node update
