improve legibility and robustness of some core code, and fix bug with deleted nodes
